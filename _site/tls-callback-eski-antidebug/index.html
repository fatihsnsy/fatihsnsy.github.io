<!DOCTYPE html> <html lang="tr-TR"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Fatih Åensoy" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Fatih Åensoy" /> <title> TLS Callback ile Eski Bir Anti-Debug TekniÄŸi - Fatih Åensoy </title> <link rel="alternate" href="https://fatihsensoy.com/tls-callback-eski-antidebug/" hreflang="tr-TR" /> <link rel="canonical" href="https://fatihsensoy.com/tls-callback-eski-antidebug/" /> <meta name="description" content="ZararlÄ± yazÄ±lÄ±mlarÄ±n uzun yÄ±llardan beridir baÅŸvurduklarÄ± Anti-Debug tekniklerinden TLS Callback&#39;e farklÄ± bir ÅŸekilde gÃ¶z atÄ±yoruz..." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="TLS Callback ile Eski Bir Anti-Debug TekniÄŸi | " /> <meta property="og:title" content="TLS Callback ile Eski Bir Anti-Debug TekniÄŸi | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://fatihsensoy.com/tls-callback-eski-antidebug/" /> <meta property="og:description" content="ZararlÄ± yazÄ±lÄ±mlarÄ±n uzun yÄ±llardan beridir baÅŸvurduklarÄ± Anti-Debug tekniklerinden TLS Callback&#39;e farklÄ± bir ÅŸekilde gÃ¶z atÄ±yoruz..." /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="TLS Callback ile Eski Bir Anti-Debug TekniÄŸi | fatihsnsy" /> <meta name="twitter:url" content="https://fatihsensoy.com/tls-callback-eski-antidebug/" /> <meta name="twitter:site" content="@fatihsnsy" /> <meta name="twitter:creator" content="@fatihsnsy" /> <meta name="twitter:description" content="ZararlÄ± yazÄ±lÄ±mlarÄ±n uzun yÄ±llardan beridir baÅŸvurduklarÄ± Anti-Debug tekniklerinden TLS Callback&#39;e farklÄ± bir ÅŸekilde gÃ¶z atÄ±yoruz..." /> <meta name="twitter:image" content="https://fatihsensoy.com/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png" /> <link type="application/atom+xml" rel="alternate" href="https://fatihsensoy.com/feed.xml" title="Fatih Åensoy" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/fav-32.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>TLS Callback ile Eski Bir Anti-Debug TekniÄŸi | Fatih Åensoy</title> <meta name="generator" content="Jekyll v4.1.1" /> <meta property="og:title" content="TLS Callback ile Eski Bir Anti-Debug TekniÄŸi" /> <meta name="author" content="Fatih ÅENSOY" /> <meta property="og:locale" content="tr_TR" /> <meta name="description" content="ZararlÄ± yazÄ±lÄ±mlarÄ±n uzun yÄ±llardan beridir baÅŸvurduklarÄ± Anti-Debug tekniklerinden TLS Callbackâ€™e farklÄ± bir ÅŸekilde gÃ¶z atÄ±yoruzâ€¦" /> <meta property="og:description" content="ZararlÄ± yazÄ±lÄ±mlarÄ±n uzun yÄ±llardan beridir baÅŸvurduklarÄ± Anti-Debug tekniklerinden TLS Callbackâ€™e farklÄ± bir ÅŸekilde gÃ¶z atÄ±yoruzâ€¦" /> <link rel="canonical" href="https://fatihsensoy.com/tls-callback-eski-antidebug/" /> <meta property="og:url" content="https://fatihsensoy.com/tls-callback-eski-antidebug/" /> <meta property="og:site_name" content="Fatih Åensoy" /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-08-26T09:00:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://fatihsensoy.com/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png" /> <meta property="twitter:title" content="TLS Callback ile Eski Bir Anti-Debug TekniÄŸi" /> <script type="application/ld+json"> {"@type":"BlogPosting","image":"https://fatihsensoy.com/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png","headline":"TLS Callback ile Eski Bir Anti-Debug TekniÄŸi","dateModified":"2020-08-26T09:00:00+00:00","datePublished":"2020-08-26T09:00:00+00:00","url":"https://fatihsensoy.com/tls-callback-eski-antidebug/","mainEntityOfPage":{"@type":"WebPage","@id":"https://fatihsensoy.com/tls-callback-eski-antidebug/"},"author":{"@type":"Person","name":"Fatih ÅENSOY"},"description":"ZararlÄ± yazÄ±lÄ±mlarÄ±n uzun yÄ±llardan beridir baÅŸvurduklarÄ± Anti-Debug tekniklerinden TLS Callbackâ€™e farklÄ± bir ÅŸekilde gÃ¶z atÄ±yoruzâ€¦","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">Anasayfa</a><a class="menu-link" href="/archive/">ArÅŸiv</a><a class="menu-link" href="/about/">HakkÄ±mda</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="main_wrapper"> <div class="toc_wrapper"> <div class="toc_content"> <h2>Ä°Ã§erik</h2> <ul><li><a href="#tls-nedir">TLS Nedir?</a></li><li><a href="#tls-callback-iÌ‡le-debug-tespiti">TLS Callback Ä°le Debug Tespiti</a></li><li><a href="#kaynakÃ§a">KaynakÃ§a</a></li></ul> </div> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"></article> <header class="header"> <img src="/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png" alt="" style="border: 2px solid white; width: 100%;"><br><br> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#anti-debug-techniques">ANTI-DEBUG TECHNIQUES</a>, <a class="tag" href="/tags/#thread-local-storage">THREAD LOCAL STORAGE</a>, <a class="tag" href="/tags/#tls">TLS</a>, <a class="tag" href="/tags/#tls-callback">TLS CALLBACK</a>, <a class="tag" href="/tags/#tls-callback-anti-debug">TLS CALLBACK ANTI-DEBUG</a>, <a class="tag" href="/tags/#tls-callback-code-snippet">TLS CALLBACK CODE SNIPPET</a>, <a class="tag" href="/tags/#tls-callback-ile-anti-debug-tekniÄŸi">TLS CALLBACK ILE ANTI-DEBUG TEKNIÄI</a>, <a class="tag" href="/tags/#tls-callback-implementation">TLS CALLBACK IMPLEMENTATION</a> </span> </div> <h1 class="header-title" itemprop="headline">TLS Callback ile Eski Bir Anti-Debug TekniÄŸi</h1> <div class="post-meta"> <time datetime="2020-08-26T09:00:00+00:00" itemprop="datePublished"> Aug 26, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Fatih ÅENSOY</span> </span> <time hidden datetime="" itemprop="dateModified"> Aug 26, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Fatih ÅENSOY</span> <span hidden itemprop="image">/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png</span> <span hidden itemprop="mainEntityOfPage"><p>ZararlÄ± uygulamalar her ne kadar ofans odaklÄ± olsalar da, ofansif davranÄ±ÅŸlarÄ±nÄ± daha uzun ve etkili bir ÅŸekilde sÃ¼rdÃ¼rmek iÃ§in defansif yeteneklerini de sÄ±klÄ±kla ortaya koymaktadÄ±rlar. Bir kedi-fare oyunu olan bu alanda, zararlÄ± aktÃ¶rlerin en bÃ¼yÃ¼k hedeflerinden birisi de yazdÄ±klarÄ± zararlÄ±larÄ±n analiz edilmesini olabildiÄŸince engellemeye Ã§alÄ±ÅŸmaktÄ±r. Sizlerle birlikte adÄ±nÄ± sÄ±k sÄ±k duyduÄŸumuz, demode olan fakat kedi-fare oyunun baÅŸlangÄ±cÄ± sayÄ±labilecek bir tekniÄŸi inceleyecek ve gerÃ§eklemesini yapacaÄŸÄ±z.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>ZararlÄ± uygulamalar her ne kadar ofans odaklÄ± olsalar da, ofansif davranÄ±ÅŸlarÄ±nÄ± daha uzun ve etkili bir ÅŸekilde sÃ¼rdÃ¼rmek iÃ§in defansif yeteneklerini de sÄ±klÄ±kla ortaya koymaktadÄ±rlar. Bir kedi-fare oyunu olan bu alanda, zararlÄ± aktÃ¶rlerin en bÃ¼yÃ¼k hedeflerinden birisi de yazdÄ±klarÄ± zararlÄ±larÄ±n analiz edilmesini olabildiÄŸince engellemeye Ã§alÄ±ÅŸmaktÄ±r. Sizlerle birlikte adÄ±nÄ± sÄ±k sÄ±k duyduÄŸumuz, demode olan fakat kedi-fare oyunun baÅŸlangÄ±cÄ± sayÄ±labilecek bir tekniÄŸi inceleyecek ve gerÃ§eklemesini yapacaÄŸÄ±z.</p> <p>Fakat tekniÄŸin detaylarÄ± ve gerÃ§eklemesine geÃ§meden Ã¶nce TLSâ€™in ne olduÄŸunu bilmemiz, bize bÃ¼yÃ¼k avantaj kazandÄ±racaktÄ±r.</p> <h2 id="tls-nedir"> <a href="#tls-nedir" class="anchor-head"></a> TLS Nedir? </h2> <p>AÃ§Ä±lÄ±mÄ± <strong>Thread Local Storage</strong> olan TLS, processin iÅŸ parÃ§acÄ±klarÄ±nÄ±n (<strong>thread</strong>) kendilerine Ã¶zgÃ¼ verileri bellekte depolayabildiÄŸi bir yÃ¶ntemdir. Ã‡alÄ±ÅŸma zamanÄ±nda (<strong>runtime</strong>) iÅŸ parÃ§acÄ±ÄŸÄ±na Ã¶zgÃ¼n olan veriler TlsAlloc, TlsGetvValue, TlsSetValue gibi Windows APIâ€™leri ile desteklenebilmektedir. AyrÄ±ca bilindiÄŸi Ã¼zere bir processin tÃ¼m iÅŸ parÃ§acÄ±klarÄ± aynÄ± sanal alanÄ± paylaÅŸmaktadÄ±r. Bir fonksiyon iÃ§erisindeki lokal bir deÄŸiÅŸken, onu Ã§alÄ±ÅŸtÄ±ran iÅŸ parÃ§acÄ±ÄŸÄ±na Ã¶zgÃ¼dÃ¼r. Fakat fonksiyon haricinde yer alan statik ve global deÄŸiÅŸkenler ise, processin tÃ¼m iÅŸ parÃ§acÄ±klarÄ± ile paylaÅŸÄ±lmaktadÄ±r. TLS yapÄ±sÄ±nda oluÅŸturulan deÄŸiÅŸkenlerde ise durum biraz farklÄ±dÄ±r. TLS yapÄ±sÄ±nda iÅŸ parÃ§acÄ±klarÄ±nÄ±n, deÄŸiÅŸkenler iÃ§in kendilerine Ã¶zgÃ¼ olan kopyalarÄ± bulunmaktadÄ±r. Yani TLS yapÄ±sÄ±nda, deÄŸiÅŸtirilen bir deÄŸiÅŸkenin deÄŸeri sadece ilgili olan iÅŸ parÃ§acÄ±ÄŸÄ±nda deÄŸiÅŸime uÄŸramaktadÄ±r. DiÄŸer iÅŸ parÃ§acÄ±klarÄ±nÄ±n kendilerine Ã¶zgÃ¼ kopyalarÄ± olduÄŸundan dolayÄ± bir deÄŸiÅŸim olmamaktadÄ±r.</p> <p>TLS yapÄ±sÄ± ile, processin global bir index kullanmasÄ±yla, her iÅŸ parÃ§acÄ±ÄŸÄ±na Ã¶zgÃ¼ veriler saÄŸlamasÄ± mÃ¼mkÃ¼ndÃ¼r. AÅŸaÄŸÄ±daki gÃ¶rsel tam olarak TLSâ€™in nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlatmaktadÄ±r.</p> <p><img src="/assets/img/tls-callback-eski-antidebug-teknigi/img/cover.png" alt="TLS Callback Cover" /></p> <p>YukarÄ±daki gÃ¶rselde iki iÅŸ parÃ§acÄ±ÄŸÄ±nÄ±n TLS kullanÄ±mÄ±nÄ± gÃ¶rmektesiniz. TLS, gdwTlsIndex1 ve gdwTlsIndex2 adÄ±nda 2 adet global veri oluÅŸturur. TlsGetValue APIâ€™si ile iÅŸ parÃ§acÄ±klarÄ±nÄ±n ilgili indexlerinin karÅŸÄ±lÄ±ÄŸÄ± olan deÄŸer lpvData deÄŸiÅŸkeninde depolanÄ±r.</p> <h2 id="tls-callback-iÌ‡le-debug-tespiti"> <a href="#tls-callback-iÌ‡le-debug-tespiti" class="anchor-head"></a> TLS Callback Ä°le Debug Tespiti </h2> <p>TLSâ€™in Ã§alÄ±ÅŸma mantÄ±ÄŸÄ±nÄ± az da olsa makalenin konusunu anlayabilecek kadar kavradÄ±k. Åimdi ise asÄ±l konumuza geri dÃ¶nÃ¼yoruz. Eski bir gelenek olan (eski diyorum Ã§Ã¼nkÃ¼ gÃ¼nÃ¼mÃ¼zde bir Ã§ok modern debug tespit yÃ¶ntemleri geliÅŸtirildi. TLS Callback ile debug tespitinin nasÄ±l olduÄŸuna gÃ¶z atacaÄŸÄ±z.</p> <p>TLS Callback yÃ¶nteminin popÃ¼ler olmasÄ±nÄ±n en bÃ¼yÃ¼k sebeplerinden birisi, <strong>entrypoint</strong> noktasÄ±na gelmeden Ã¶nce Ã§alÄ±ÅŸÄ±yor olmasÄ±dÄ±r. Yani zararlÄ± aktÃ¶rler, uygulamalarÄ±nÄ±n ana amacÄ± belli olmadan Ã¶nce, programÄ±n baÅŸlangÄ±cÄ±nda TLS Callback yÃ¶ntemi ile zararlÄ± uygulamalarÄ±nÄ±n debug edilip edilmediÄŸini anlayabilmektedirler. Eski bir anti-debug tekniÄŸi olan TLS Callback, gÃ¼nÃ¼mÃ¼zde kolaylÄ±kla bypass edilebilmektedir.</p> <p>TLS Callback anti-debug tekniÄŸini daha iyi anlamak adÄ±na uygulamasÄ±nÄ± yapalÄ±m.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;windows.h&gt;
#pragma comment(lib, "ntdll.lib")
#pragma section(".CRT$XLB", read) //.CRT$XLB adÄ±nda yeni bir section oluÅŸturduk. Section adÄ±nÄ±n aynÄ± olmasÄ± gerekmektedir.
#define NtCurrentProcess() (HANDLE)-1
</span><span class="k">extern</span> <span class="s">"C"</span> <span class="n">NTSTATUS</span> <span class="n">NTAPI</span> <span class="nf">NtQueryInformationProcess</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">InfoClass</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">Length</span><span class="p">,</span> <span class="n">PULONG</span> <span class="n">ReturnLength</span><span class="p">);</span>
<span class="cp">#ifdef _WIN64
#pragma comment(linker, "/INCLUDE:_tls_used")
#define readpeb (PBOOLEAN)__readgsdword(0x60) + 2 //PEB yapÄ±sÄ±nda BeingDebugged'a iÅŸaret ediyor. x64 iÃ§in
#else
#pragma comment(linker, "/INCLUDE:__tls_used")
#define readpeb (PBOOLEAN)__readfsdword(0x30) + 2 //x32 iÃ§in
#endif
</span><span class="kt">void</span> <span class="n">WINAPI</span> <span class="nf">DebuggerDetect</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">handle</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">Reason</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">Reserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PBOOLEAN</span> <span class="n">BeingDebugged</span> <span class="o">=</span> <span class="n">readpeb</span><span class="p">;</span>
    <span class="n">HANDLE</span> <span class="n">DebugPort</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">BeingDebugged</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Debugger Detected!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"No debugger detected!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NtQueryInformationProcess</span><span class="p">(</span><span class="n">NtCurrentProcess</span><span class="p">(),</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DebugPort</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">HANDLE</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span> 
        <span class="c1">//DebugPort 0 deÄŸilse programÄ±n debug edildiÄŸinin gÃ¶stergesidir.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">DebugPort</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Debugger Detected via QueryInformationProcess!!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"No debugger detected for QueryInformationProcess</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kr">__declspec</span><span class="p">(</span><span class="n">allocate</span><span class="p">(</span><span class="s">".CRT$XLB"</span><span class="p">))</span> <span class="n">PIMAGE_TLS_CALLBACK</span> <span class="n">CallbackAddress</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DebuggerDetect</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Hello, you're now in the entrypoint!"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>YukarÄ±daki implementesini yaptÄ±ÄŸÄ±mÄ±z TLS Callback ile anti-debug tekniÄŸine bir gÃ¶z atalÄ±m. <strong>NtQueryInformationProcess</strong> APIâ€™si ile de bir anti-debug tekniÄŸini eklediÄŸimiz Ã¶rneÄŸimizde pragma anahtar sÃ¶zcÃ¼kleri ile derleyicimize talimatlar vermekteyiz. Ntdll kÃ¼tÃ¼phanesini dahil et, yeni bir section oluÅŸtur, linkerâ€™a belirtilenleri baÄŸla gibi komutlarÄ± zaten kodun iÃ§erisinde gÃ¶rmektesiniz. Buradaki en Ã¶nemli noktalardan birisi <strong>__declspec</strong> anahtar sÃ¶zcÃ¼ÄŸÃ¼ ile tanÄ±m yaptÄ±ÄŸÄ±mÄ±z satÄ±rdÄ±r. Pragma anahtar sÃ¶zcÃ¼ÄŸÃ¼nde oluÅŸturduÄŸumuz section iÃ§in yer ayÄ±rma yapÄ±yoruz ve TLS Callback fonksiyonumuzun adresini veriyoruz. Daha sonra yazmÄ±ÅŸ olduÄŸumuz <strong>DebuggerDetect</strong> fonksiyonu Ã§alÄ±ÅŸÄ±yor ve bu fonksiyondan sonra <strong>main</strong>() fonksiyonumuz Ã§alÄ±ÅŸÄ±yor.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ntdll!_PEB
   +0x000 InheritedAddressSpace : UChar
   +0x001 ReadImageFileExecOptions : UChar
   +0x002 BeingDebugged    : UChar
   +0x003 BitField         : UChar
   +0x003 ImageUsesLargePages : Pos 0, 1 Bit
   +0x003 IsProtectedProcess : Pos 1, 1 Bit
   +0x003 IsImageDynamicallyRelocated : Pos 2, 1 Bit
   +0x003 SkipPatchingUser32Forwarders : Pos 3, 1 Bit
   +0x003 IsPackagedProcess : Pos 4, 1 Bit
   +0x003 IsAppContainer   : Pos 5, 1 Bit
   +0x003 IsProtectedProcessLight : Pos 6, 1 Bit
   +0x003 IsLongPathAwareProcess : Pos 7, 1 Bit
   +0x004 Padding0         : [4] UChar
   +0x008 Mutant           : Ptr64 Void
   +0x010 ImageBaseAddress : Ptr64 Void
   +0x018 Ldr              : Ptr64 _PEB_LDR_DATA
   +0x020 ProcessParameters : Ptr64 _RTL_USER_PROCESS_PARAMETERS
   +0x028 SubSystemData    : Ptr64 Void
   +0x030 ProcessHeap      : Ptr64 Void
   +0x038 FastPebLock      : Ptr64 _RTL_CRITICAL_SECTION
   +0x040 AtlThunkSListPtr : Ptr64 _SLIST_HEADER
   +0x048 IFEOKey          : Ptr64 Void
   +0x050 CrossProcessFlags : Uint4B
   +0x050 ProcessInJob     : Pos 0, 1 Bit
   +0x050 ProcessInitializing : Pos 1, 1 Bit
   +0x050 ProcessUsingVEH  : Pos 2, 1 Bit
   +0x050 ProcessUsingVCH  : Pos 3, 1 Bit
   +0x050 ProcessUsingFTH  : Pos 4, 1 Bit
   +0x050 ProcessPreviouslyThrottled : Pos 5, 1 Bit
   +0x050 ProcessCurrentlyThrottled : Pos 6, 1 Bit
   +0x050 ReservedBits0    : Pos 7, 25 Bits
   +0x054 Padding1         : [4] UChar
   +0x058 KernelCallbackTable : Ptr64 Void
   +0x058 UserSharedInfoPtr : Ptr64 Void
   +0x060 SystemReserved   : Uint4B
   +0x064 AtlThunkSListPtr32 : Uint4B
   +0x068 ApiSetMap        : Ptr64 Void
   +0x070 TlsExpansionCounter : Uint4B
   +0x074 Padding2         : [4] UChar
   +0x078 TlsBitmap        : Ptr64 Void
   +0x080 TlsBitmapBits    : [2] Uint4B
   +0x088 ReadOnlySharedMemoryBase : Ptr64 Void
   +0x090 SharedData       : Ptr64 Void
   +0x098 ReadOnlyStaticServerData : Ptr64 Ptr64 Void
   +0x0a0 AnsiCodePageData : Ptr64 Void
   +0x0a8 OemCodePageData  : Ptr64 Void
   +0x0b0 UnicodeCaseTableData : Ptr64 Void
   +0x0b8 NumberOfProcessors : Uint4B
   +0x0bc NtGlobalFlag     : Uint4B
   +0x0c0 CriticalSectionTimeout : _LARGE_INTEGER
   +0x0c8 HeapSegmentReserve : Uint8B
   +0x0d0 HeapSegmentCommit : Uint8B
   +0x0d8 HeapDeCommitTotalFreeThreshold : Uint8B
   +0x0e0 HeapDeCommitFreeBlockThreshold : Uint8B
   +0x0e8 NumberOfHeaps    : Uint4B
   +0x0ec MaximumNumberOfHeaps : Uint4B
   +0x0f0 ProcessHeaps     : Ptr64 Ptr64 Void
   +0x0f8 GdiSharedHandleTable : Ptr64 Void
   +0x100 ProcessStarterHelper : Ptr64 Void
   +0x108 GdiDCAttributeList : Uint4B
   +0x10c Padding3         : [4] UChar
   +0x110 LoaderLock       : Ptr64 _RTL_CRITICAL_SECTION
   +0x118 OSMajorVersion   : Uint4B
   +0x11c OSMinorVersion   : Uint4B
   +0x120 OSBuildNumber    : Uint2B
   +0x122 OSCSDVersion     : Uint2B
   +0x124 OSPlatformId     : Uint4B
   +0x128 ImageSubsystem   : Uint4B
   +0x12c ImageSubsystemMajorVersion : Uint4B
   +0x130 ImageSubsystemMinorVersion : Uint4B
   +0x134 Padding4         : [4] UChar
   +0x138 ActiveProcessAffinityMask : Uint8B
   +0x140 GdiHandleBuffer  : [60] Uint4B
   +0x230 PostProcessInitRoutine : Ptr64     void 
   +0x238 TlsExpansionBitmap : Ptr64 Void
   +0x240 TlsExpansionBitmapBits : [32] Uint4B
   +0x2c0 SessionId        : Uint4B
   +0x2c4 Padding5         : [4] UChar
   +0x2c8 AppCompatFlags   : _ULARGE_INTEGER
   +0x2d0 AppCompatFlagsUser : _ULARGE_INTEGER
   +0x2d8 pShimData        : Ptr64 Void
   +0x2e0 AppCompatInfo    : Ptr64 Void
   +0x2e8 CSDVersion       : _UNICODE_STRING
   +0x2f8 ActivationContextData : Ptr64 _ACTIVATION_CONTEXT_DATA
   +0x300 ProcessAssemblyStorageMap : Ptr64 _ASSEMBLY_STORAGE_MAP
   +0x308 SystemDefaultActivationContextData : Ptr64 _ACTIVATION_CONTEXT_DATA
   +0x310 SystemAssemblyStorageMap : Ptr64 _ASSEMBLY_STORAGE_MAP
   +0x318 MinimumStackCommit : Uint8B
   +0x320 FlsCallback      : Ptr64 _FLS_CALLBACK_INFO
   +0x328 FlsListHead      : _LIST_ENTRY
   +0x338 FlsBitmap        : Ptr64 Void
   +0x340 FlsBitmapBits    : [4] Uint4B
   +0x350 FlsHighIndex     : Uint4B
   +0x358 WerRegistrationData : Ptr64 Void
   +0x360 WerShipAssertPtr : Ptr64 Void
   +0x368 pUnused          : Ptr64 Void
   +0x370 pImageHeaderHash : Ptr64 Void
   +0x378 TracingFlags     : Uint4B
   +0x378 HeapTracingEnabled : Pos 0, 1 Bit
   +0x378 CritSecTracingEnabled : Pos 1, 1 Bit
   +0x378 LibLoaderTracingEnabled : Pos 2, 1 Bit
   +0x378 SpareTracingBits : Pos 3, 29 Bits
   +0x37c Padding6         : [4] UChar
   +0x380 CsrServerReadOnlySharedMemoryBase : Uint8B
   +0x388 TppWorkerpListLock : Uint8B
   +0x390 TppWorkerpList   : _LIST_ENTRY
   +0x3a0 WaitOnAddressHashTable : [128] Ptr64 Void
   +0x7a0 TelemetryCoverageHeader : Ptr64 Void
   +0x7a8 CloudFileFlags   : Uint4B
   +0x7ac CloudFileDiagFlags : Uint4B
   +0x7b0 PlaceholderCompatibilityMode : Char
   +0x7b1 PlaceholderCompatibilityModeReserved : [7] Char
</code></pre></div></div> <p>x86 ve x64 mimari uyumlu olan implementemizde, Ã¶ncelikle mimariye gÃ¶re PEB yapÄ±sÄ±na eriÅŸmemiz gerekiyor. PEB yapÄ±sÄ±na eriÅŸtikten sonra yukarÄ±daki tabloda da gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ Ã¼zere yapÄ±nÄ±n 3. sÄ±radaki deÄŸiÅŸkeni olan BeingDebuggedâ€™a eriÅŸim saÄŸlamak adÄ±na 2. indexi belirtiyoruz.EÄŸer BeingDebugged 0â€™dan farklÄ± bir deÄŸere sahip ise bu, programÄ±n debug edildiÄŸi anlamÄ±na gelmektedir. AyrÄ±ca yukarÄ±daki kod parÃ§asÄ±nda mimariye gÃ¶re PEBâ€™in konumunun farklÄ±lÄ±k gÃ¶sterdiÄŸi gÃ¶z ardÄ± edilmemelidir.</p> <p>PEB ile anti-debug tekniÄŸinin ardÄ±ndan kÃ¼Ã§Ã¼k bir ekleme daha yaparak anti-debug uygulamamÄ±zÄ± biraz daha geliÅŸtiriyoruz. Windows APIâ€™larÄ±nÄ±n sunduÄŸu nimetlerden faydanalanarak, uygulamanÄ±nÄ± debug edilip edilmediÄŸini anlayabilmekteyiz. Ã–rnekte gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ Ã¼zere <strong>NtQueryInformationProcess</strong> APIâ€™si ile benzer bir anti-debug tekniÄŸi kullanmÄ±ÅŸ olduk. Ä°lgili API, az Ã¶nce bahsettiÄŸimiz gibi kendisi mimariye gÃ¶re PEBâ€™in baÅŸlangÄ±Ã§ noktasÄ±nÄ± bulur ve bizimle neredeyse aynÄ± iÅŸlemleri yapar. <strong>ProcessInformationClass</strong> parametresine geÃ§tiÄŸimiz 7 deÄŸeri ile <strong>DebugPort</strong> deÄŸiÅŸkenine atama yapmaktayÄ±z. EÄŸer DebugPort deÄŸiÅŸkeni 0â€™dan farklÄ± bir deÄŸere sahip ise programÄ±n debug edildiÄŸi anlaÅŸÄ±lmaktadÄ±r.</p> <p><img src="/assets/img/tls-callback-eski-antidebug-teknigi/img/tls-callback-1.png" alt="TLS Callback Result" /></p> <p>Sizlere bu makalemde TLSâ€™in genel olarak tanÄ±mÄ± ve yapÄ±sÄ±, TLS Callback ile debug tespiti ve PEB yapÄ±sÄ±na deÄŸinmiÅŸ olduk. Bir sonraki makalelerimde farklÄ± anti-debug ve anti-reverse teknikleri ile karÅŸÄ±nÄ±zda olacaÄŸÄ±m. SaÄŸlÄ±cakla kalÄ±nâ€¦</p> <h2 id="kaynakÃ§a"> <a href="#kaynakÃ§a" class="anchor-head"></a> KaynakÃ§a </h2> <p>[1] https://en.wikipedia.org/wiki/Thread-local_storage</p> <p>[2] https://docs.microsoft.com/tr-tr/cpp/parallel/thread-local-storage-tls</p> <p>[3] https://docs.microsoft.com/en-us/windows/win32/procthread/thread-local-storage</p> <p>[4] http://rinseandrepeatanalysis.blogspot.com/p/peb-structure.html</p> </div> </article> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'fatihsensoy'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/perdenin-ardindakiler-0x01/" > <div class="nav-arrow">Previous</div> <span class="post-title">Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak</span> </a> <a class="post-nav-item post-nav-next" href="/dlinjector-hizli-dll-enjeksiyonu/"> <div class="nav-arrow">Next</div> <span class="post-title">DLInjector â€“ HÄ±zlÄ± DLL Enjeksiyon AracÄ±</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="mailto:iletisim@fatihsensoy.com">Contact Me ğŸ“§</a> <a class="footer_item" href="/feed.xml">RSS</a> <small class="footer_copyright"> <span class="footer_item">Fatih Åensoy &copy;2021</span> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155173124-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-155173124-1'); </script> </div> </div> </body> </html>
