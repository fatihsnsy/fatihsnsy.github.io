<!DOCTYPE html> <html lang="tr-TR"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Fatih Şensoy" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Fatih Şensoy" /> <title> Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak - Fatih Şensoy </title> <link rel="alternate" href="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" hreflang="tr-TR" /> <link rel="canonical" href="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta name="description" content="Perdenin Ardındakiler serisinin 0x01 adresinde Android zararlısını ışığa kavuşturuyoruz." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak | " /> <meta property="og:title" content="Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta property="og:description" content="Perdenin Ardındakiler serisinin 0x01 adresinde Android zararlısını ışığa kavuşturuyoruz." /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak | fatihsnsy" /> <meta name="twitter:url" content="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta name="twitter:site" content="@fatihsnsy" /> <meta name="twitter:creator" content="@fatihsnsy" /> <meta name="twitter:description" content="Perdenin Ardındakiler serisinin 0x01 adresinde Android zararlısını ışığa kavuşturuyoruz." /> <meta name="twitter:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <link type="application/atom+xml" rel="alternate" href="https://fatihsensoy.com/feed.xml" title="Fatih Şensoy" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/fav-32.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak | Fatih Şensoy</title> <meta name="generator" content="Jekyll v4.1.1" /> <meta property="og:title" content="Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak" /> <meta name="author" content="Fatih ŞENSOY" /> <meta property="og:locale" content="tr_TR" /> <meta name="description" content="Perdenin Ardındakiler serisinin 0x01 adresinde Android zararlısını ışığa kavuşturuyoruz." /> <meta property="og:description" content="Perdenin Ardındakiler serisinin 0x01 adresinde Android zararlısını ışığa kavuşturuyoruz." /> <link rel="canonical" href="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta property="og:url" content="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta property="og:site_name" content="Fatih Şensoy" /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-05-10T19:59:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <meta property="twitter:title" content="Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak" /> <script type="application/ld+json"> {"@type":"BlogPosting","image":"https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg","headline":"Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak","dateModified":"2020-05-10T19:59:00+00:00","datePublished":"2020-05-10T19:59:00+00:00","url":"https://fatihsensoy.com/perdenin-ardindakiler-0x01/","mainEntityOfPage":{"@type":"WebPage","@id":"https://fatihsensoy.com/perdenin-ardindakiler-0x01/"},"author":{"@type":"Person","name":"Fatih ŞENSOY"},"description":"Perdenin Ardındakiler serisinin 0x01 adresinde Android zararlısını ışığa kavuşturuyoruz.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">Anasayfa</a><a class="menu-link" href="/archive/">Arşiv</a><a class="menu-link" href="/about/">Hakkımda</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="main_wrapper"> <div class="toc_wrapper"> <div class="toc_content"> <h2>İçerik</h2> <ul><li><a href="#giriş">Giriş</a></li><li><a href="#decrypt-rutinin-tespiti">Decrypt Rutinin Tespiti</a></li><li><a href="#obfuscate-edilmiş-verinin-tespiti">Obfuscate Edilmiş Verinin Tespiti</a></li><li><a href="#trace-trace-trace">Trace Trace Trace!</a></li><li><a href="#emin-olma-ve-c-zamanı">Emin Olma Ve C# Zamanı</a></li></ul> </div> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"></article> <header class="header"> <img src="/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" alt="" style="border: 2px solid white; width: 100%;"><br><br> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#android-malware">ANDROID MALWARE</a>, <a class="tag" href="/tags/#android-malware-analysis">ANDROID MALWARE ANALYSIS</a>, <a class="tag" href="/tags/#android-malware-deobfuscation">ANDROID MALWARE DEOBFUSCATION</a>, <a class="tag" href="/tags/#droiddream">DROIDDREAM</a>, <a class="tag" href="/tags/#droidream-malware-analysis">DROIDREAM MALWARE ANALYSIS</a>, <a class="tag" href="/tags/#malware-deobfuscation">MALWARE DEOBFUSCATION</a> </span> </div> <h1 class="header-title" itemprop="headline">Perdenin Ardındakiler 0x01 - Android Zararlısını Işığa Kavuşturmak</h1> <div class="post-meta"> <time datetime="2020-05-10T19:59:00+00:00" itemprop="datePublished"> May 10, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Fatih ŞENSOY</span> </span> <time hidden datetime="" itemprop="dateModified"> May 10, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Fatih ŞENSOY</span> <span hidden itemprop="image">/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg</span> <span hidden itemprop="mainEntityOfPage"><p>Selamlar dostlar…</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Selamlar dostlar…</p> <p>Zararlı yazılım analiz raporları her gün, her hafta ve her ay karşımıza çıkmakta. Raporların içeriğinde de sık sık “<strong>Teknik analizler sonucunda gizlenmiş IP adresi karşımıza çıkmakta</strong>” veya “<strong>Decryption işlemi sonucunda zararlı URL bulmaktayız</strong>” gibi ifadeleri görüyoruz. E tamam decryption işlemi yaptın da ulaştın obfuscate edilmiş URL’e ama nasıl yaptın? Bu sorunu baz aldım ve piyasada decryption işleminin nasıl yapıldığına dair çok fazla içerik bulunmadığını gördüm. Bu eksiklikten yola çıkarak analizini yapıp deobfuscate ettiğim zararlı yazılımları, nasıl deobfuscate ettiğime dair bilgilendiri, eğitici ve ileri seviye teknik bir seri başlatıyorum. Serinin adı da “<strong>Perdenin Ardındakiler!</strong>”</p> <p><del>(Evet isim aklıma geldikten sonra araştırma yaptım, böyle bir müzik grubu olduğunu öğrenmiş oldum, olayın müzikle pek alakası yok 🙂 )</del></p> <p>Perdenin Ardındakiler serisinin ilk içeriği olan 0x01’de sizlere çook uzun süre ortaya çıkmış olan Android zararlısı <strong>DroidDream</strong>’in içerisinde yer alan obfuscate edilmiş, yani plaintext olarak okuyamadığımız ve belirli bir decrypt rutininden sonra dinamik olarak ortaya çıkan komuta kontrol sunucusunun statik olarak nasıl deobfuscate edilip bizlere ışıklar içinde görüneceğini anlatacağım. Serinin ilk içeriği olması sebebiyle biraz basitten başlayıp işin mantığını kavramaya çalışacağız.</p> <h3 id="giriş"> <a href="#giriş" class="anchor-head"></a> Giriş </h3> <p>DroidDream zararlısı içerisinde birkaç farklı yapı barındırmakta. Android’in bir zafiyetini kullanarak sistemi exploit etmekte ve uzaktan ilgili binary’ye bağlantı sağlandığında ise bağlanan saldırgana ROOT yetkisi vermektedir. Bu seride zararlılara çok fazla değinmeden ön izlenim geçeceğim çünkü konumuz Malware Analiz Raporu değil, o malware içerisindeki gizlenmiş indikatörleri ortaya çıkarmak.</p> <p>Öncelikle bir dex decompiler’a ihtiyacımız var. Bu da Desktop Zararlı Analizleri sırasındaki IDA’nın yerini alacak olan <strong>Jadx</strong>’ten başka bir tool olamaz tabi! Aslında IDA ile de decompile edebilirdik sonuçta dalvik bytecodelarını da decompile edebiliyor ama Android zararlıları için pek de amaca uygun değil.</p> <p>Şimdi ne yapacağız? Jadx ile direk APK dosyamızı açacağız. Tebrikler, kısmen doğru cevap verdiniz. Tam doğru olanı ise Jadx’i komut satırı üzerinden <code class="language-plaintext highlighter-rouge">--show-bad-code</code> parametresi ile başlatmak. Sebebi ise Jadx’in decompile işlemi yaparken bazı metodları tam olarak ayırştırıp Java kodu olarak sunamamasından dolayı bu parametre ile başlatıyoruz ve diyoruz ki “<strong>Sen decompile edebildiğin kadarını göster bize</strong>”. Ve karşımıza yine de güzel bir Java metodu çıkmış oluyor. Bu işlemi yapmaz isek karşılaşacağımı tablo aşağıdaki gibi olmaktadır.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-1.png" alt="pa01-1" /></p> <h3 id="decrypt-rutinin-tespiti"> <a href="#decrypt-rutinin-tespiti" class="anchor-head"></a> Decrypt Rutinin Tespiti </h3> <p>Giriş kısmında zararlı APK’mızı show-bad-code modunda JADX’te decompile etmiştik. Şimdi ise neyi deobfuscate edeceğimizi bulmamız gerekiyor. Bunun için en iyi yol uygulamanın çalışma hiyerarşisine göre trace etmek. Yani main sınıfından başlayıp “ne nereye gidiyor, hangi parametreleri yolluyor?” sorusunu kendinize sorup çözüm aramaya çalışırsanız karşınızda bir anda aşağıdaki görselde olduğu gibi Xor veya matematiksel işlemlerin yoğun olduğu bir kod parçası belirecektir.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-2.png" alt="pa01-2" /></p> <p>Crypt metodunu incelediğimizde buffer adında byte tipinde bir diziyi parametre olmakta almakta. Daha sonra yaptığı işlem ise buffer dizisinin boyu kadar i değişkenini bir bir artırıp dizinin i. indisindeki değer il KEYVALUE dizisinin pos indisindeki değeri xor işlemine tabi tutmak. İç içe for döngüsü kullanılabilirdi fakat saldırgan pos değerini <strong>pos++</strong> işlemi ile artırmayı tercih etmiş. Hemen aşağısında bulunan if döngüsü bu konu için bizi alakadar etmemektedir.</p> <p><strong>KEYVALUE</strong> adındaki byte dizisi nerede diye sorarsanız saldırgan bunu her yerde tanımlamış olabilir. Ama bizim örneğimizde sınıfın en üstünde tanımlanmış durumda ve içerisinde barındırdığı değerler de ilgi çekici.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-3.png" alt="pa01-3" /></p> <p>Bir string dizisini <strong>getBytes</strong>() metodu ile baytlara çevirmiş ve sonucunda da byte tipinde KEYVALUE adındaki diziye tanımlamış durumda.</p> <h3 id="obfuscate-edilmiş-verinin-tespiti"> <a href="#obfuscate-edilmiş-verinin-tespiti" class="anchor-head"></a> Obfuscate Edilmiş Verinin Tespiti </h3> <p>Decrypt rutinini tespit etmiştik. Ve içerisine bir bayt dizisi almakta idi. Yani çözeceği veri bir byte dizisinin içinde olmalı veyahut başka veri tipinde dizi olup, byte veri tipine zorlanmış olmalı. Uygulamayı yine çalıştırma hiyerarşisine göre analiz ettiğimizde karşımıza tam da aradığımız şekilde bir bayt dizisi çıkmakta.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-4.png" alt="pa01-4" /></p> <p><strong>bArr</strong> adındaki byte dizisini bulduk ve obfuscate edilmiş veri olduğundan şüphelendik diyelim. Peki bundan sonra ne yapacağız? Cevap basit. bArr dizisini trace etmek, yani izini sürmek. Kapsamı bArr dizisi ile daralttığımız için işimiz gerçekten de kolay oluyor.</p> <h3 id="trace-trace-trace"> <a href="#trace-trace-trace" class="anchor-head"></a> Trace Trace Trace! </h3> <p>Saldırgan 45 boylu bArr adındaki byte veri tipindeki diziye görselden de gördüğünüz üzere atamalar yapmış bulunmakta. Atamaların sonuna geldiğimizde ise **u = bArr; **şeklinde bir referans ataması olduğunu görüyoruz. Java’da referans atamasının karşılığını C’de pointer geçme olarak aklınızda tutabilirsiniz. Saldırgan burada izini kaybettirmeye çalışmış. Artık trace etmemiz gereken değişken udeğişkeni oluyor. Ve biraz daha analize devam ettiğimizde ise onCreate() metodunun üst kısımlarında aradığımızı görebilmekteyiz.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-5.png" alt="pa01-5" /></p> <p>Gördüğünüz üzere obfuscate edildiğinden şüphe ettiğimiz verilerin tutulup referansının u değişkenine atandığı dizinin bir kopyasını alıp byte veri tipinde c adında başka bir diziye atamakta. Bunun hemen altında ise decrypt rutini olan crypt metoduna c’yi parametre olarak geçmekte. Bunun sonucunda ise artık obfuscate edildiğinden şüphe duyduğumuz veri çözümlenmekte.</p> <p>Dikkat ederseniz şu ana kadar hep “obfuscate edildiğinden şüphe duyduğumuz veri” cümlesini kullandım. Çünkü henüz emin değiliz ve bunun gibi bir çok dizi olabilirdi. Saldırgan analistin işini zorlaştırmak için ne taklalar atıyor bir bilseniz!</p> <h3 id="emin-olma-ve-c-zamanı"> <a href="#emin-olma-ve-c-zamanı" class="anchor-head"></a> Emin Olma Ve C# Zamanı </h3> <p>Şimdiye kadar yaptığımız şey aslında tüm uygulamayı trace ettikten sonra decrypt rutini ve akabinde obfuscate edilen verinin ne yollarla decrypt rutinine yollandığının algoritmasını kafamızda çözümlemekti. Şimdi ise sıra teorilerimizi kanıtlamaya ve biraz da kod yazmaya geldi.</p> <p>Yapacağımız ilk şey tanımlamalar olmakta. İlk olarak Xor anahtarlarını tanımlıyoruz. Daha sonra ise obfuscate edilmiş bArr dizisini ve tüm içeriklerini tanımlıyoruz.</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">string</span> <span class="n">KEYVALUE</span> <span class="p">=</span> <span class="s">"6^)(9-p35a%3#4S!4S0)$Yt%^&amp;5(j.g^&amp;o(*0)$Yv!#O@6GpG@=+3j.&amp;6^)(0-=1"</span><span class="p">;</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">anahtar</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">KEYVALUE</span><span class="p">);</span> <span class="c1">//Stringi byte olarak alıyoruz.</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">bArr</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">45</span><span class="p">];</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">94</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">42</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="m">93</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="m">88</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">6</span><span class="p">]</span> <span class="p">=</span> <span class="m">95</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">7</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">8</span><span class="p">]</span> <span class="p">=</span> <span class="m">13</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">9</span><span class="p">]</span> <span class="p">=</span> <span class="m">85</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">10</span><span class="p">]</span> <span class="p">=</span> <span class="m">11</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">11</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">12</span><span class="p">]</span> <span class="p">=</span> <span class="m">19</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">13</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">14</span><span class="p">]</span> <span class="p">=</span> <span class="m">125</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">15</span><span class="p">]</span> <span class="p">=</span> <span class="m">19</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">17</span><span class="p">]</span> <span class="p">=</span> <span class="m">102</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">18</span><span class="p">]</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">19</span><span class="p">]</span> <span class="p">=</span> <span class="m">24</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">20</span><span class="p">]</span> <span class="p">=</span> <span class="m">19</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">21</span><span class="p">]</span> <span class="p">=</span> <span class="m">99</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">22</span><span class="p">]</span> <span class="p">=</span> <span class="m">76</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">23</span><span class="p">]</span> <span class="p">=</span> <span class="m">21</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">24</span><span class="p">]</span> <span class="p">=</span> <span class="m">102</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">25</span><span class="p">]</span> <span class="p">=</span> <span class="m">22</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">26</span><span class="p">]</span> <span class="p">=</span> <span class="m">26</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">27</span><span class="p">]</span> <span class="p">=</span> <span class="m">111</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">28</span><span class="p">]</span> <span class="p">=</span> <span class="m">39</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">29</span><span class="p">]</span> <span class="p">=</span> <span class="m">125</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">30</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">31</span><span class="p">]</span> <span class="p">=</span> <span class="m">44</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">32</span><span class="p">]</span> <span class="p">=</span> <span class="m">80</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">33</span><span class="p">]</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">34</span><span class="p">]</span> <span class="p">=</span> <span class="m">90</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">35</span><span class="p">]</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">36</span><span class="p">]</span> <span class="p">=</span> <span class="m">119</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">37</span><span class="p">]</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">38</span><span class="p">]</span> <span class="p">=</span> <span class="m">119</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">39</span><span class="p">]</span> <span class="p">=</span> <span class="m">60</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">40</span><span class="p">]</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">41</span><span class="p">]</span> <span class="p">=</span> <span class="m">87</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">42</span><span class="p">]</span> <span class="p">=</span> <span class="m">79</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">43</span><span class="p">]</span> <span class="p">=</span> <span class="m">42</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">44</span><span class="p">]</span> <span class="p">=</span> <span class="m">52</span><span class="p">;</span>
</code></pre></div></div> <p>Dikkat edilmesi gereken noktalardan birisi ise saldırgan Java’daki getBytes() metodunu default biçiminde kullanmış. Yani UTF8’den baytlara çevirmiş. Bizde C#’da bunu belirterek yapıyoruz. Java’daki gibi direk bir kullanımı C#’da bulunmuyor.</p> <p>Decrypt adındaki metodumuzu yazmaya başlıyoruz.</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">void</span> <span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">dizi</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">anahtar</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dizi</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">dizi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">dizi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="n">anahtar</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="kt">string</span> <span class="n">urlPlain</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">dizi</span><span class="p">);</span> 
                <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"URL: "</span> <span class="p">+</span> <span class="n">urlPlain</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div></div> <p>Kod parçasında görüldüğü üzere pos değişkenini hiç hesaba katmadık. Yaptığımız tek şey dizi adındaki dizi ve anahtar dizisini de karşılık gelen i. indisteki değer ile xor işlemine tabi tutmak oldu. Dizinin içerisinde bulunan değer bayt türünde olduğundan dolayı baytları UTF8 biçimindeki stringlere, C#’ın GetString() metodu sayesinde dönüştürüp, ekrana çıktılama yaptık ve karşımıza gelen sonuç, yüz güldüren cinstendi 🙂</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-6.png" alt="pa01-6" /></p> <p>Kodun tam halini buradan görebilirsiniz. Github Gist üzerinden de indirebilirsiniz.</p> <p>Perdenin Ardındakiler serisinin 0x01 bölümünde sizlere Android zararlısı Droid Dream’e decryption kodu yazarak tün indikatörleri ışığa kavuşturmayı anlatttım. Herhangi bir sorunuz, öneriniz olursa yorumlardan bana bildirebilirsiniz. Bu arada pratik yapmak için de DroidDream zararlısının hashini buraya bırakıyorum. “Hep sayfanın en üstüne koyarlar sen neden en alta hash koyuyorsun” diye merak ettiyseniz de konuyu tam olarak dinleyip, daha sonra pratik yapmanızın daha doğru olduğunu düşünüyorum şeklinde bir cevap verebilirim 🙂</p> <p>Serinin bir sonraki bölümünde görüşmek üzere, sağlıcakla kalın…</p> <p><code class="language-plaintext highlighter-rouge">DroidDream MD5 HASH: ecad34c72d2388aafec0a1352bff2dd9 </code></p> </div> </article> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'fatihsensoy'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/Process-Injection-Teknikleri/" > <div class="nav-arrow">Previous</div> <span class="post-title">💉 Process Injection Teknikleri Ve Detayları</span> </a> <a class="post-nav-item post-nav-next" href="/tls-callback-eski-antidebug/"> <div class="nav-arrow">Next</div> <span class="post-title">TLS Callback ile Eski Bir Anti-Debug Tekniği</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="mailto:iletisim@fatihsensoy.com">Contact Me 📧</a> <a class="footer_item" href="/feed.xml">RSS</a> <small class="footer_copyright"> <span class="footer_item">Fatih Şensoy &copy;2021</span> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155173124-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-155173124-1'); </script> </div> </div> </body> </html>
