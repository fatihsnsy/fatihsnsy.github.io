<!DOCTYPE html> <html lang="tr-TR"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Fatih Åensoy" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Fatih Åensoy" /> <title> Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak - Fatih Åensoy </title> <link rel="alternate" href="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" hreflang="tr-TR" /> <link rel="canonical" href="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta name="description" content="Perdenin ArdÄ±ndakiler serisinin 0x01 adresinde Android zararlÄ±sÄ±nÄ± Ä±ÅŸÄ±ÄŸa kavuÅŸturuyoruz." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak | " /> <meta property="og:title" content="Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta property="og:description" content="Perdenin ArdÄ±ndakiler serisinin 0x01 adresinde Android zararlÄ±sÄ±nÄ± Ä±ÅŸÄ±ÄŸa kavuÅŸturuyoruz." /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak | fatihsnsy" /> <meta name="twitter:url" content="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta name="twitter:site" content="@fatihsnsy" /> <meta name="twitter:creator" content="@fatihsnsy" /> <meta name="twitter:description" content="Perdenin ArdÄ±ndakiler serisinin 0x01 adresinde Android zararlÄ±sÄ±nÄ± Ä±ÅŸÄ±ÄŸa kavuÅŸturuyoruz." /> <meta name="twitter:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <link type="application/atom+xml" rel="alternate" href="https://fatihsensoy.com/feed.xml" title="Fatih Åensoy" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/fav-32.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak | Fatih Åensoy</title> <meta name="generator" content="Jekyll v4.1.1" /> <meta property="og:title" content="Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak" /> <meta name="author" content="Fatih ÅENSOY" /> <meta property="og:locale" content="tr_TR" /> <meta name="description" content="Perdenin ArdÄ±ndakiler serisinin 0x01 adresinde Android zararlÄ±sÄ±nÄ± Ä±ÅŸÄ±ÄŸa kavuÅŸturuyoruz." /> <meta property="og:description" content="Perdenin ArdÄ±ndakiler serisinin 0x01 adresinde Android zararlÄ±sÄ±nÄ± Ä±ÅŸÄ±ÄŸa kavuÅŸturuyoruz." /> <link rel="canonical" href="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta property="og:url" content="https://fatihsensoy.com/perdenin-ardindakiler-0x01/" /> <meta property="og:site_name" content="Fatih Åensoy" /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-05-10T19:59:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" /> <meta property="twitter:title" content="Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak" /> <script type="application/ld+json"> {"@type":"BlogPosting","image":"https://fatihsensoy.com/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg","headline":"Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak","dateModified":"2020-05-10T19:59:00+00:00","datePublished":"2020-05-10T19:59:00+00:00","url":"https://fatihsensoy.com/perdenin-ardindakiler-0x01/","mainEntityOfPage":{"@type":"WebPage","@id":"https://fatihsensoy.com/perdenin-ardindakiler-0x01/"},"author":{"@type":"Person","name":"Fatih ÅENSOY"},"description":"Perdenin ArdÄ±ndakiler serisinin 0x01 adresinde Android zararlÄ±sÄ±nÄ± Ä±ÅŸÄ±ÄŸa kavuÅŸturuyoruz.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">Anasayfa</a><a class="menu-link" href="/archive/">ArÅŸiv</a><a class="menu-link" href="/about/">HakkÄ±mda</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="main_wrapper"> <div class="toc_wrapper"> <div class="toc_content"> <h2>Ä°Ã§erik</h2> <ul><li><a href="#giriÅŸ">GiriÅŸ</a></li><li><a href="#decrypt-rutinin-tespiti">Decrypt Rutinin Tespiti</a></li><li><a href="#obfuscate-edilmiÅŸ-verinin-tespiti">Obfuscate EdilmiÅŸ Verinin Tespiti</a></li><li><a href="#trace-trace-trace">Trace Trace Trace!</a></li><li><a href="#emin-olma-ve-c-zamanÄ±">Emin Olma Ve C# ZamanÄ±</a></li></ul> </div> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"></article> <header class="header"> <img src="/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg" alt="" style="border: 2px solid white; width: 100%;"><br><br> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#android-malware">ANDROID MALWARE</a>, <a class="tag" href="/tags/#android-malware-analysis">ANDROID MALWARE ANALYSIS</a>, <a class="tag" href="/tags/#android-malware-deobfuscation">ANDROID MALWARE DEOBFUSCATION</a>, <a class="tag" href="/tags/#droiddream">DROIDDREAM</a>, <a class="tag" href="/tags/#droidream-malware-analysis">DROIDREAM MALWARE ANALYSIS</a>, <a class="tag" href="/tags/#malware-deobfuscation">MALWARE DEOBFUSCATION</a> </span> </div> <h1 class="header-title" itemprop="headline">Perdenin ArdÄ±ndakiler 0x01 - Android ZararlÄ±sÄ±nÄ± IÅŸÄ±ÄŸa KavuÅŸturmak</h1> <div class="post-meta"> <time datetime="2020-05-10T19:59:00+00:00" itemprop="datePublished"> May 10, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Fatih ÅENSOY</span> </span> <time hidden datetime="" itemprop="dateModified"> May 10, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Fatih ÅENSOY</span> <span hidden itemprop="image">/assets/img/perdenin-ardindakiler-0x01/img/cover.jpg</span> <span hidden itemprop="mainEntityOfPage"><p>Selamlar dostlarâ€¦</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Selamlar dostlarâ€¦</p> <p>ZararlÄ± yazÄ±lÄ±m analiz raporlarÄ± her gÃ¼n, her hafta ve her ay karÅŸÄ±mÄ±za Ã§Ä±kmakta. RaporlarÄ±n iÃ§eriÄŸinde de sÄ±k sÄ±k â€œ<strong>Teknik analizler sonucunda gizlenmiÅŸ IP adresi karÅŸÄ±mÄ±za Ã§Ä±kmakta</strong>â€ veya â€œ<strong>Decryption iÅŸlemi sonucunda zararlÄ± URL bulmaktayÄ±z</strong>â€ gibi ifadeleri gÃ¶rÃ¼yoruz. E tamam decryption iÅŸlemi yaptÄ±n da ulaÅŸtÄ±n obfuscate edilmiÅŸ URLâ€™e ama nasÄ±l yaptÄ±n? Bu sorunu baz aldÄ±m ve piyasada decryption iÅŸleminin nasÄ±l yapÄ±ldÄ±ÄŸÄ±na dair Ã§ok fazla iÃ§erik bulunmadÄ±ÄŸÄ±nÄ± gÃ¶rdÃ¼m. Bu eksiklikten yola Ã§Ä±karak analizini yapÄ±p deobfuscate ettiÄŸim zararlÄ± yazÄ±lÄ±mlarÄ±, nasÄ±l deobfuscate ettiÄŸime dair bilgilendiri, eÄŸitici ve ileri seviye teknik bir seri baÅŸlatÄ±yorum. Serinin adÄ± da â€œ<strong>Perdenin ArdÄ±ndakiler!</strong>â€</p> <p><del>(Evet isim aklÄ±ma geldikten sonra araÅŸtÄ±rma yaptÄ±m, bÃ¶yle bir mÃ¼zik grubu olduÄŸunu Ã¶ÄŸrenmiÅŸ oldum, olayÄ±n mÃ¼zikle pek alakasÄ± yok ğŸ™‚ )</del></p> <p>Perdenin ArdÄ±ndakiler serisinin ilk iÃ§eriÄŸi olan 0x01â€™de sizlere Ã§ook uzun sÃ¼re ortaya Ã§Ä±kmÄ±ÅŸ olan Android zararlÄ±sÄ± <strong>DroidDream</strong>â€™in iÃ§erisinde yer alan obfuscate edilmiÅŸ, yani plaintext olarak okuyamadÄ±ÄŸÄ±mÄ±z ve belirli bir decrypt rutininden sonra dinamik olarak ortaya Ã§Ä±kan komuta kontrol sunucusunun statik olarak nasÄ±l deobfuscate edilip bizlere Ä±ÅŸÄ±klar iÃ§inde gÃ¶rÃ¼neceÄŸini anlatacaÄŸÄ±m. Serinin ilk iÃ§eriÄŸi olmasÄ± sebebiyle biraz basitten baÅŸlayÄ±p iÅŸin mantÄ±ÄŸÄ±nÄ± kavramaya Ã§alÄ±ÅŸacaÄŸÄ±z.</p> <h3 id="giriÅŸ"> <a href="#giriÅŸ" class="anchor-head"></a> GiriÅŸ </h3> <p>DroidDream zararlÄ±sÄ± iÃ§erisinde birkaÃ§ farklÄ± yapÄ± barÄ±ndÄ±rmakta. Androidâ€™in bir zafiyetini kullanarak sistemi exploit etmekte ve uzaktan ilgili binaryâ€™ye baÄŸlantÄ± saÄŸlandÄ±ÄŸÄ±nda ise baÄŸlanan saldÄ±rgana ROOT yetkisi vermektedir. Bu seride zararlÄ±lara Ã§ok fazla deÄŸinmeden Ã¶n izlenim geÃ§eceÄŸim Ã§Ã¼nkÃ¼ konumuz Malware Analiz Raporu deÄŸil, o malware iÃ§erisindeki gizlenmiÅŸ indikatÃ¶rleri ortaya Ã§Ä±karmak.</p> <p>Ã–ncelikle bir dex decompilerâ€™a ihtiyacÄ±mÄ±z var. Bu da Desktop ZararlÄ± Analizleri sÄ±rasÄ±ndaki IDAâ€™nÄ±n yerini alacak olan <strong>Jadx</strong>â€™ten baÅŸka bir tool olamaz tabi! AslÄ±nda IDA ile de decompile edebilirdik sonuÃ§ta dalvik bytecodelarÄ±nÄ± da decompile edebiliyor ama Android zararlÄ±larÄ± iÃ§in pek de amaca uygun deÄŸil.</p> <p>Åimdi ne yapacaÄŸÄ±z? Jadx ile direk APK dosyamÄ±zÄ± aÃ§acaÄŸÄ±z. Tebrikler, kÄ±smen doÄŸru cevap verdiniz. Tam doÄŸru olanÄ± ise Jadxâ€™i komut satÄ±rÄ± Ã¼zerinden <code class="language-plaintext highlighter-rouge">--show-bad-code</code> parametresi ile baÅŸlatmak. Sebebi ise Jadxâ€™in decompile iÅŸlemi yaparken bazÄ± metodlarÄ± tam olarak ayÄ±rÅŸtÄ±rÄ±p Java kodu olarak sunamamasÄ±ndan dolayÄ± bu parametre ile baÅŸlatÄ±yoruz ve diyoruz ki â€œ<strong>Sen decompile edebildiÄŸin kadarÄ±nÄ± gÃ¶ster bize</strong>â€. Ve karÅŸÄ±mÄ±za yine de gÃ¼zel bir Java metodu Ã§Ä±kmÄ±ÅŸ oluyor. Bu iÅŸlemi yapmaz isek karÅŸÄ±laÅŸacaÄŸÄ±mÄ± tablo aÅŸaÄŸÄ±daki gibi olmaktadÄ±r.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-1.png" alt="pa01-1" /></p> <h3 id="decrypt-rutinin-tespiti"> <a href="#decrypt-rutinin-tespiti" class="anchor-head"></a> Decrypt Rutinin Tespiti </h3> <p>GiriÅŸ kÄ±smÄ±nda zararlÄ± APKâ€™mÄ±zÄ± show-bad-code modunda JADXâ€™te decompile etmiÅŸtik. Åimdi ise neyi deobfuscate edeceÄŸimizi bulmamÄ±z gerekiyor. Bunun iÃ§in en iyi yol uygulamanÄ±n Ã§alÄ±ÅŸma hiyerarÅŸisine gÃ¶re trace etmek. Yani main sÄ±nÄ±fÄ±ndan baÅŸlayÄ±p â€œne nereye gidiyor, hangi parametreleri yolluyor?â€ sorusunu kendinize sorup Ã§Ã¶zÃ¼m aramaya Ã§alÄ±ÅŸÄ±rsanÄ±z karÅŸÄ±nÄ±zda bir anda aÅŸaÄŸÄ±daki gÃ¶rselde olduÄŸu gibi Xor veya matematiksel iÅŸlemlerin yoÄŸun olduÄŸu bir kod parÃ§asÄ± belirecektir.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-2.png" alt="pa01-2" /></p> <p>Crypt metodunu incelediÄŸimizde buffer adÄ±nda byte tipinde bir diziyi parametre olmakta almakta. Daha sonra yaptÄ±ÄŸÄ± iÅŸlem ise buffer dizisinin boyu kadar i deÄŸiÅŸkenini bir bir artÄ±rÄ±p dizinin i. indisindeki deÄŸer il KEYVALUE dizisinin pos indisindeki deÄŸeri xor iÅŸlemine tabi tutmak. Ä°Ã§ iÃ§e for dÃ¶ngÃ¼sÃ¼ kullanÄ±labilirdi fakat saldÄ±rgan pos deÄŸerini <strong>pos++</strong> iÅŸlemi ile artÄ±rmayÄ± tercih etmiÅŸ. Hemen aÅŸaÄŸÄ±sÄ±nda bulunan if dÃ¶ngÃ¼sÃ¼ bu konu iÃ§in bizi alakadar etmemektedir.</p> <p><strong>KEYVALUE</strong> adÄ±ndaki byte dizisi nerede diye sorarsanÄ±z saldÄ±rgan bunu her yerde tanÄ±mlamÄ±ÅŸ olabilir. Ama bizim Ã¶rneÄŸimizde sÄ±nÄ±fÄ±n en Ã¼stÃ¼nde tanÄ±mlanmÄ±ÅŸ durumda ve iÃ§erisinde barÄ±ndÄ±rdÄ±ÄŸÄ± deÄŸerler de ilgi Ã§ekici.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-3.png" alt="pa01-3" /></p> <p>Bir string dizisini <strong>getBytes</strong>() metodu ile baytlara Ã§evirmiÅŸ ve sonucunda da byte tipinde KEYVALUE adÄ±ndaki diziye tanÄ±mlamÄ±ÅŸ durumda.</p> <h3 id="obfuscate-edilmiÅŸ-verinin-tespiti"> <a href="#obfuscate-edilmiÅŸ-verinin-tespiti" class="anchor-head"></a> Obfuscate EdilmiÅŸ Verinin Tespiti </h3> <p>Decrypt rutinini tespit etmiÅŸtik. Ve iÃ§erisine bir bayt dizisi almakta idi. Yani Ã§Ã¶zeceÄŸi veri bir byte dizisinin iÃ§inde olmalÄ± veyahut baÅŸka veri tipinde dizi olup, byte veri tipine zorlanmÄ±ÅŸ olmalÄ±. UygulamayÄ± yine Ã§alÄ±ÅŸtÄ±rma hiyerarÅŸisine gÃ¶re analiz ettiÄŸimizde karÅŸÄ±mÄ±za tam da aradÄ±ÄŸÄ±mÄ±z ÅŸekilde bir bayt dizisi Ã§Ä±kmakta.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-4.png" alt="pa01-4" /></p> <p><strong>bArr</strong> adÄ±ndaki byte dizisini bulduk ve obfuscate edilmiÅŸ veri olduÄŸundan ÅŸÃ¼phelendik diyelim. Peki bundan sonra ne yapacaÄŸÄ±z? Cevap basit. bArr dizisini trace etmek, yani izini sÃ¼rmek. KapsamÄ± bArr dizisi ile daralttÄ±ÄŸÄ±mÄ±z iÃ§in iÅŸimiz gerÃ§ekten de kolay oluyor.</p> <h3 id="trace-trace-trace"> <a href="#trace-trace-trace" class="anchor-head"></a> Trace Trace Trace! </h3> <p>SaldÄ±rgan 45 boylu bArr adÄ±ndaki byte veri tipindeki diziye gÃ¶rselden de gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z Ã¼zere atamalar yapmÄ±ÅŸ bulunmakta. AtamalarÄ±n sonuna geldiÄŸimizde ise **u = bArr; **ÅŸeklinde bir referans atamasÄ± olduÄŸunu gÃ¶rÃ¼yoruz. Javaâ€™da referans atamasÄ±nÄ±n karÅŸÄ±lÄ±ÄŸÄ±nÄ± Câ€™de pointer geÃ§me olarak aklÄ±nÄ±zda tutabilirsiniz. SaldÄ±rgan burada izini kaybettirmeye Ã§alÄ±ÅŸmÄ±ÅŸ. ArtÄ±k trace etmemiz gereken deÄŸiÅŸken udeÄŸiÅŸkeni oluyor. Ve biraz daha analize devam ettiÄŸimizde ise onCreate() metodunun Ã¼st kÄ±sÄ±mlarÄ±nda aradÄ±ÄŸÄ±mÄ±zÄ± gÃ¶rebilmekteyiz.</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-5.png" alt="pa01-5" /></p> <p>GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z Ã¼zere obfuscate edildiÄŸinden ÅŸÃ¼phe ettiÄŸimiz verilerin tutulup referansÄ±nÄ±n u deÄŸiÅŸkenine atandÄ±ÄŸÄ± dizinin bir kopyasÄ±nÄ± alÄ±p byte veri tipinde c adÄ±nda baÅŸka bir diziye atamakta. Bunun hemen altÄ±nda ise decrypt rutini olan crypt metoduna câ€™yi parametre olarak geÃ§mekte. Bunun sonucunda ise artÄ±k obfuscate edildiÄŸinden ÅŸÃ¼phe duyduÄŸumuz veri Ã§Ã¶zÃ¼mlenmekte.</p> <p>Dikkat ederseniz ÅŸu ana kadar hep â€œobfuscate edildiÄŸinden ÅŸÃ¼phe duyduÄŸumuz veriâ€ cÃ¼mlesini kullandÄ±m. Ã‡Ã¼nkÃ¼ henÃ¼z emin deÄŸiliz ve bunun gibi bir Ã§ok dizi olabilirdi. SaldÄ±rgan analistin iÅŸini zorlaÅŸtÄ±rmak iÃ§in ne taklalar atÄ±yor bir bilseniz!</p> <h3 id="emin-olma-ve-c-zamanÄ±"> <a href="#emin-olma-ve-c-zamanÄ±" class="anchor-head"></a> Emin Olma Ve C# ZamanÄ± </h3> <p>Åimdiye kadar yaptÄ±ÄŸÄ±mÄ±z ÅŸey aslÄ±nda tÃ¼m uygulamayÄ± trace ettikten sonra decrypt rutini ve akabinde obfuscate edilen verinin ne yollarla decrypt rutinine yollandÄ±ÄŸÄ±nÄ±n algoritmasÄ±nÄ± kafamÄ±zda Ã§Ã¶zÃ¼mlemekti. Åimdi ise sÄ±ra teorilerimizi kanÄ±tlamaya ve biraz da kod yazmaya geldi.</p> <p>YapacaÄŸÄ±mÄ±z ilk ÅŸey tanÄ±mlamalar olmakta. Ä°lk olarak Xor anahtarlarÄ±nÄ± tanÄ±mlÄ±yoruz. Daha sonra ise obfuscate edilmiÅŸ bArr dizisini ve tÃ¼m iÃ§eriklerini tanÄ±mlÄ±yoruz.</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">string</span> <span class="n">KEYVALUE</span> <span class="p">=</span> <span class="s">"6^)(9-p35a%3#4S!4S0)$Yt%^&amp;5(j.g^&amp;o(*0)$Yv!#O@6GpG@=+3j.&amp;6^)(0-=1"</span><span class="p">;</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">anahtar</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">KEYVALUE</span><span class="p">);</span> <span class="c1">//Stringi byte olarak alÄ±yoruz.</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">bArr</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">45</span><span class="p">];</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">94</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="m">42</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="m">93</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="m">88</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">4</span><span class="p">]</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">5</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">6</span><span class="p">]</span> <span class="p">=</span> <span class="m">95</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">7</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">8</span><span class="p">]</span> <span class="p">=</span> <span class="m">13</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">9</span><span class="p">]</span> <span class="p">=</span> <span class="m">85</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">10</span><span class="p">]</span> <span class="p">=</span> <span class="m">11</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">11</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">12</span><span class="p">]</span> <span class="p">=</span> <span class="m">19</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">13</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">14</span><span class="p">]</span> <span class="p">=</span> <span class="m">125</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">15</span><span class="p">]</span> <span class="p">=</span> <span class="m">19</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">17</span><span class="p">]</span> <span class="p">=</span> <span class="m">102</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">18</span><span class="p">]</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">19</span><span class="p">]</span> <span class="p">=</span> <span class="m">24</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">20</span><span class="p">]</span> <span class="p">=</span> <span class="m">19</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">21</span><span class="p">]</span> <span class="p">=</span> <span class="m">99</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">22</span><span class="p">]</span> <span class="p">=</span> <span class="m">76</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">23</span><span class="p">]</span> <span class="p">=</span> <span class="m">21</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">24</span><span class="p">]</span> <span class="p">=</span> <span class="m">102</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">25</span><span class="p">]</span> <span class="p">=</span> <span class="m">22</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">26</span><span class="p">]</span> <span class="p">=</span> <span class="m">26</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">27</span><span class="p">]</span> <span class="p">=</span> <span class="m">111</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">28</span><span class="p">]</span> <span class="p">=</span> <span class="m">39</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">29</span><span class="p">]</span> <span class="p">=</span> <span class="m">125</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">30</span><span class="p">]</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">31</span><span class="p">]</span> <span class="p">=</span> <span class="m">44</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">32</span><span class="p">]</span> <span class="p">=</span> <span class="m">80</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">33</span><span class="p">]</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">34</span><span class="p">]</span> <span class="p">=</span> <span class="m">90</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">35</span><span class="p">]</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">36</span><span class="p">]</span> <span class="p">=</span> <span class="m">119</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">37</span><span class="p">]</span> <span class="p">=</span> <span class="m">100</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">38</span><span class="p">]</span> <span class="p">=</span> <span class="m">119</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">39</span><span class="p">]</span> <span class="p">=</span> <span class="m">60</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">40</span><span class="p">]</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">41</span><span class="p">]</span> <span class="p">=</span> <span class="m">87</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">42</span><span class="p">]</span> <span class="p">=</span> <span class="m">79</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">43</span><span class="p">]</span> <span class="p">=</span> <span class="m">42</span><span class="p">;</span>
                <span class="n">bArr</span><span class="p">[</span><span class="m">44</span><span class="p">]</span> <span class="p">=</span> <span class="m">52</span><span class="p">;</span>
</code></pre></div></div> <p>Dikkat edilmesi gereken noktalardan birisi ise saldÄ±rgan Javaâ€™daki getBytes() metodunu default biÃ§iminde kullanmÄ±ÅŸ. Yani UTF8â€™den baytlara Ã§evirmiÅŸ. Bizde C#â€™da bunu belirterek yapÄ±yoruz. Javaâ€™daki gibi direk bir kullanÄ±mÄ± C#â€™da bulunmuyor.</p> <p>Decrypt adÄ±ndaki metodumuzu yazmaya baÅŸlÄ±yoruz.</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">void</span> <span class="nf">decrypt</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">dizi</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">anahtar</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">dizi</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">dizi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">dizi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="n">anahtar</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="kt">string</span> <span class="n">urlPlain</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">dizi</span><span class="p">);</span> 
                <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"URL: "</span> <span class="p">+</span> <span class="n">urlPlain</span><span class="p">)</span>
            <span class="p">}</span>
</code></pre></div></div> <p>Kod parÃ§asÄ±nda gÃ¶rÃ¼ldÃ¼ÄŸÃ¼ Ã¼zere pos deÄŸiÅŸkenini hiÃ§ hesaba katmadÄ±k. YaptÄ±ÄŸÄ±mÄ±z tek ÅŸey dizi adÄ±ndaki dizi ve anahtar dizisini de karÅŸÄ±lÄ±k gelen i. indisteki deÄŸer ile xor iÅŸlemine tabi tutmak oldu. Dizinin iÃ§erisinde bulunan deÄŸer bayt tÃ¼rÃ¼nde olduÄŸundan dolayÄ± baytlarÄ± UTF8 biÃ§imindeki stringlere, C#â€™Ä±n GetString() metodu sayesinde dÃ¶nÃ¼ÅŸtÃ¼rÃ¼p, ekrana Ã§Ä±ktÄ±lama yaptÄ±k ve karÅŸÄ±mÄ±za gelen sonuÃ§, yÃ¼z gÃ¼ldÃ¼ren cinstendi ğŸ™‚</p> <p><img src="/assets/img/perdenin-ardindakiler-0x01/img/pa01-6.png" alt="pa01-6" /></p> <p>Kodun tam halini buradan gÃ¶rebilirsiniz. Github Gist Ã¼zerinden de indirebilirsiniz.</p> <p>Perdenin ArdÄ±ndakiler serisinin 0x01 bÃ¶lÃ¼mÃ¼nde sizlere Android zararlÄ±sÄ± Droid Dreamâ€™e decryption kodu yazarak tÃ¼n indikatÃ¶rleri Ä±ÅŸÄ±ÄŸa kavuÅŸturmayÄ± anlatttÄ±m. Herhangi bir sorunuz, Ã¶neriniz olursa yorumlardan bana bildirebilirsiniz. Bu arada pratik yapmak iÃ§in de DroidDream zararlÄ±sÄ±nÄ±n hashini buraya bÄ±rakÄ±yorum. â€œHep sayfanÄ±n en Ã¼stÃ¼ne koyarlar sen neden en alta hash koyuyorsunâ€ diye merak ettiyseniz de konuyu tam olarak dinleyip, daha sonra pratik yapmanÄ±zÄ±n daha doÄŸru olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼yorum ÅŸeklinde bir cevap verebilirim ğŸ™‚</p> <p>Serinin bir sonraki bÃ¶lÃ¼mÃ¼nde gÃ¶rÃ¼ÅŸmek Ã¼zere, saÄŸlÄ±cakla kalÄ±nâ€¦</p> <p><code class="language-plaintext highlighter-rouge">DroidDream MD5 HASH: ecad34c72d2388aafec0a1352bff2dd9 </code></p> </div> </article> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'fatihsensoy'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/Process-Injection-Teknikleri/" > <div class="nav-arrow">Previous</div> <span class="post-title">ğŸ’‰ Process Injection Teknikleri Ve DetaylarÄ±</span> </a> <a class="post-nav-item post-nav-next" href="/tls-callback-eski-antidebug/"> <div class="nav-arrow">Next</div> <span class="post-title">TLS Callback ile Eski Bir Anti-Debug TekniÄŸi</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="mailto:iletisim@fatihsensoy.com">Contact Me ğŸ“§</a> <a class="footer_item" href="/feed.xml">RSS</a> <small class="footer_copyright"> <span class="footer_item">Fatih Åensoy &copy;2021</span> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155173124-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-155173124-1'); </script> </div> </div> </body> </html>
