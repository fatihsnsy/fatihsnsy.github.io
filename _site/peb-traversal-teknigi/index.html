<!DOCTYPE html> <html lang="tr-TR"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Fatih Şensoy" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Fatih Şensoy" /> <title> PEB Traversal Tekniği - Fatih Şensoy </title> <link rel="alternate" href="https://fatihsensoy.com/peb-traversal-teknigi/" hreflang="tr-TR" /> <link rel="canonical" href="https://fatihsensoy.com/peb-traversal-teknigi/" /> <meta name="description" content="Son yıllarda ortaya çıkan evasion tekniklerinden birisi olan PEB Traversal&#39;ı teknik ayrıntıları ile anlattığım. İyi okumalar..." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="PEB Traversal Tekniği | " /> <meta property="og:title" content="PEB Traversal Tekniği | " /> <meta property="og:type" content="website" /> <meta property="og:url" content="https://fatihsensoy.com/peb-traversal-teknigi/" /> <meta property="og:description" content="Son yıllarda ortaya çıkan evasion tekniklerinden birisi olan PEB Traversal&#39;ı teknik ayrıntıları ile anlattığım. İyi okumalar..." /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/peb_traversal_teknigi/img/cover.jpg" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="PEB Traversal Tekniği | fatihsnsy" /> <meta name="twitter:url" content="https://fatihsensoy.com/peb-traversal-teknigi/" /> <meta name="twitter:site" content="@fatihsnsy" /> <meta name="twitter:creator" content="@fatihsnsy" /> <meta name="twitter:description" content="Son yıllarda ortaya çıkan evasion tekniklerinden birisi olan PEB Traversal&#39;ı teknik ayrıntıları ile anlattığım. İyi okumalar..." /> <meta name="twitter:image" content="https://fatihsensoy.com/assets/img/peb_traversal_teknigi/img/cover.jpg" /> <link type="application/atom+xml" rel="alternate" href="https://fatihsensoy.com/feed.xml" title="Fatih Şensoy" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/fav-32.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>PEB Traversal Tekniği | Fatih Şensoy</title> <meta name="generator" content="Jekyll v4.1.1" /> <meta property="og:title" content="PEB Traversal Tekniği" /> <meta name="author" content="Fatih ŞENSOY" /> <meta property="og:locale" content="tr_TR" /> <meta name="description" content="Son yıllarda ortaya çıkan evasion tekniklerinden birisi olan PEB Traversal’ı teknik ayrıntıları ile anlattığım. İyi okumalar…" /> <meta property="og:description" content="Son yıllarda ortaya çıkan evasion tekniklerinden birisi olan PEB Traversal’ı teknik ayrıntıları ile anlattığım. İyi okumalar…" /> <link rel="canonical" href="https://fatihsensoy.com/peb-traversal-teknigi/" /> <meta property="og:url" content="https://fatihsensoy.com/peb-traversal-teknigi/" /> <meta property="og:site_name" content="Fatih Şensoy" /> <meta property="og:image" content="https://fatihsensoy.com/assets/img/peb_traversal_teknigi/img/cover.jpg" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-11-24T23:20:00+00:00" /> <meta name="twitter:card" content="summary_large_image" /> <meta property="twitter:image" content="https://fatihsensoy.com/assets/img/peb_traversal_teknigi/img/cover.jpg" /> <meta property="twitter:title" content="PEB Traversal Tekniği" /> <script type="application/ld+json"> {"@type":"BlogPosting","image":"https://fatihsensoy.com/assets/img/peb_traversal_teknigi/img/cover.jpg","headline":"PEB Traversal Tekniği","dateModified":"2020-11-24T23:20:00+00:00","datePublished":"2020-11-24T23:20:00+00:00","url":"https://fatihsensoy.com/peb-traversal-teknigi/","mainEntityOfPage":{"@type":"WebPage","@id":"https://fatihsensoy.com/peb-traversal-teknigi/"},"author":{"@type":"Person","name":"Fatih ŞENSOY"},"description":"Son yıllarda ortaya çıkan evasion tekniklerinden birisi olan PEB Traversal’ı teknik ayrıntıları ile anlattığım. İyi okumalar…","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body data-theme="dark" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">Anasayfa</a><a class="menu-link" href="/archive/">Arşiv</a><a class="menu-link" href="/about/">Hakkımda</a><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="main_wrapper"> <div class="toc_wrapper"> <div class="toc_content"> <h2>İçerik</h2> <ul><li><a href="#peb-nedir">PEB Nedir?</a></li><li><a href="#tehdit-aktörleri-pebi-nasıl-kullanıyor">Tehdit Aktörleri PEB’i Nasıl Kullanıyor?</a></li><li><a href="#i̇mplementasyonunu-yapalım">İmplementasyonunu Yapalım!</a></li><li><a href="#kaynakça">Kaynakça</a></li></ul> </div> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"></article> <header class="header"> <img src="/assets/img/peb_traversal_teknigi/img/cover.jpg" alt="" style="border: 2px solid white; width: 100%;"><br><br> <div class="tags"> <span itemprop="keywords"> <a class="tag" href="/tags/#peb-traversal">PEB TRAVERSAL</a>, <a class="tag" href="/tags/#traversal-techniques">TRAVERSAL TECHNIQUES</a>, <a class="tag" href="/tags/#process-environment-block-traversal">PROCESS ENVIRONMENT BLOCK TRAVERSAL</a>, <a class="tag" href="/tags/#dynamic-api-loading">DYNAMIC API LOADING</a>, <a class="tag" href="/tags/#dll-loading">DLL LOADING</a> </span> </div> <h1 class="header-title" itemprop="headline">PEB Traversal Tekniği</h1> <div class="post-meta"> <time datetime="2020-11-24T23:20:00+00:00" itemprop="datePublished"> Nov 24, 2020 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Fatih ŞENSOY</span> </span> <time hidden datetime="" itemprop="dateModified"> Nov 24, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Fatih ŞENSOY</span> <span hidden itemprop="image">/assets/img/peb_traversal_teknigi/img/cover.jpg</span> <span hidden itemprop="mainEntityOfPage"><p>Tehdit aktörleri ve zararlı yazılım analistleri arasında mücadele ortaya çıkan yeni teknikler, araçlar ve bilgi birikimleri sayesinde her geçen gün daha da kritik bir hal alıyor. Tehdit aktörleri analistler ve güvenlik ürünlerinden kaçınmak için farklı teknikler ortaya koyuyorlar. Bu teknik makalemizde sizlere gün geçtikçe popülerleşen bir teknik olan PEB Traversal (PEB Geçişi) tekniğinin ayrıtnılarını ve küçük bir örnek ile de implementasyonunu (gerçeklemesini) göstereceğim.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>Tehdit aktörleri ve zararlı yazılım analistleri arasında mücadele ortaya çıkan yeni teknikler, araçlar ve bilgi birikimleri sayesinde her geçen gün daha da kritik bir hal alıyor. Tehdit aktörleri analistler ve güvenlik ürünlerinden kaçınmak için farklı teknikler ortaya koyuyorlar. Bu teknik makalemizde sizlere gün geçtikçe popülerleşen bir teknik olan PEB Traversal (PEB Geçişi) tekniğinin ayrıtnılarını ve küçük bir örnek ile de implementasyonunu (gerçeklemesini) göstereceğim.</p> <h2 id="peb-nedir"> <a href="#peb-nedir" class="anchor-head"></a> PEB Nedir? </h2> <p>Process Environment Block(Süreç Çevre Bloğu) açılımı olan PEB, Windows işletim sisteminde bulunan bir veri yapısıdır. Bu veri yapısında;</p> <ul> <li>global bağlamlar,</li> <li>programın başlangıç parametreleri,</li> <li>programın imaj base adresi,</li> <li>karşılıklı dışlama sağlamak için kullanılan senkronizasyon öğeleri,</li> <li>programın bellek alanında yüklü olan modüllerin yapısı</li> </ul> <p>gibi öğeler barınmaktadır. PEB yapısı aşağıda görülmektedir:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_PEB</span> <span class="p">{</span>
  <span class="n">BYTE</span>                          <span class="n">Reserved1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">BYTE</span>                          <span class="n">BeingDebugged</span><span class="p">;</span>
  <span class="n">BYTE</span>                          <span class="n">Reserved2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">PVOID</span>                         <span class="n">Reserved3</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">PPEB_LDR_DATA</span>                 <span class="n">Ldr</span><span class="p">;</span>
  <span class="n">PRTL_USER_PROCESS_PARAMETERS</span>  <span class="n">ProcessParameters</span><span class="p">;</span>
  <span class="n">PVOID</span>                         <span class="n">Reserved4</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">PVOID</span>                         <span class="n">AtlThunkSListPtr</span><span class="p">;</span>
  <span class="n">PVOID</span>                         <span class="n">Reserved5</span><span class="p">;</span>
  <span class="n">ULONG</span>                         <span class="n">Reserved6</span><span class="p">;</span>
  <span class="n">PVOID</span>                         <span class="n">Reserved7</span><span class="p">;</span>
  <span class="n">ULONG</span>                         <span class="n">Reserved8</span><span class="p">;</span>
  <span class="n">ULONG</span>                         <span class="n">AtlThunkSListPtr32</span><span class="p">;</span>
  <span class="n">PVOID</span>                         <span class="n">Reserved9</span><span class="p">[</span><span class="mi">45</span><span class="p">];</span>
  <span class="n">BYTE</span>                          <span class="n">Reserved10</span><span class="p">[</span><span class="mi">96</span><span class="p">];</span>
  <span class="n">PPS_POST_PROCESS_INIT_ROUTINE</span> <span class="n">PostProcessInitRoutine</span><span class="p">;</span>
  <span class="n">BYTE</span>                          <span class="n">Reserved11</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
  <span class="n">PVOID</span>                         <span class="n">Reserved12</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">ULONG</span>                         <span class="n">SessionId</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PEB</span><span class="p">,</span> <span class="o">*</span><span class="n">PPEB</span><span class="p">;</span>
</code></pre></div></div> <p>PEB, user-modda çalışan, processler için olmazsa olmazlardandır. Böyle kritik bir yapının user-modda çalışmasının nedeni, image loader ve heap manager gibi kernel mod dışında çalışan, NTDLL gibi işletim sistemi kütüphanelerinin içerisinde bulunan diğer user-mod API’ları tarafından kullanılmak üzere tasarlanmasıdır.</p> <h2 id="tehdit-aktörleri-pebi-nasıl-kullanıyor"> <a href="#tehdit-aktörleri-pebi-nasıl-kullanıyor" class="anchor-head"></a> Tehdit Aktörleri PEB’i Nasıl Kullanıyor? </h2> <p>PEB’in içerisinde, processin bellek alanında var olan modüllere erişilen bir yapının olduğundan bahsetmiştik. PEB_LDR_DATA adındaki bu yapı aşağıdaki gibi özetlenebilir:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_PEB_LDR_DATA</span> <span class="p">{</span>
  <span class="n">BYTE</span>       <span class="n">Reserved1</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="n">PVOID</span>      <span class="n">Reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderModuleList</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PEB_LDR_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">PPEB_LDR_DATA</span><span class="p">;</span>
</code></pre></div></div> <p>Tehdit aktörleri, Anti-virüs sistemlerinden kaçınmak amacı ile bir API Resolving tekniği olan PEB Traversal tekniğini sık sık kullanmaktadırlar. PEB Traversal tekniğini tam olarak implemente edebilmek için iki şeye ihtiyaç vardır. İlk olarak PEB yapısı içerisinde bulunan, process için load edilmiş olan modüller hakkında bilgiler tutan PEB_LDR_DATA yapısına erişip tüm modülleri ve modüllerin export ettiği tüm fonksiyonları (API’ları) gezip (Traversal) hash karşılaştırması yapan bir fonksiyon, ve akabinde de işin temeli olan bir hash fonksiyonuna ihtiyacımız bulunmaktadır. Şimdi bu parçaları birleştirerek PEB Traversal tekniğinin tekniğinin sözde bir algoritmasını sıralayım.</p> <ol> <li>Traversal işlemini yapan fonksiyonumuz her export edilen API’ın hardcoded şeklindeki adını hash fonksiyonuna gönderir.</li> <li>Hash fonksiyonu kendi yapısal algoritmasına göre bir hash değeri hesaplar ve bu değeri return eder.</li> <li>Return edilen değer, zararlı yazılım içerisinde hardcoded hashler ile karşılaştırılır. Bu hardcoded hash değerleri, tehdit aktörleri tarafından kullanılmak istenen Windows API’larının daha önce alınmış değerleridir.</li> <li>Eğer runtime anında Traversal yaparak alınan hash değerleri ile daha önce tehdit aktörü tarafından hesaplanıp hardcoded şekilde yerleştirilmiş hash değerleri eşleşiyor ise başka bir değişken, eşleşen API’ın bellek üzerindeki adresini tutar. Yani buraya kadar olan kısımda klasik LoadLibrary ve GetProcAddress API’larının yapacağı işi, AV tespitine yakalanmadan gerçekleştirmiş olur.</li> </ol> <h2 id="i̇mplementasyonunu-yapalım"> <a href="#i̇mplementasyonunu-yapalım" class="anchor-head"></a> İmplementasyonunu Yapalım! </h2> <p>Yukarıda sözde algoritmamızı zaten anlatmıştık. Şimdi ise sıra bu algoritmayı gerçek koda dökmeye geldi. Aşağıdaki kod bloğu herşeyi yeterince açıklamakta. Ek olarak yukarıda bahsetmiş olduğum “bir hash algoritması seçmemiz veya üretmemiz gerekli” kısmına tekrar değinecek olursak, ben örneğimde DJB2 hash algoritmasını seçtiğimi de belirteyim.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include &lt;windows.h&gt;
#include &lt;winternl.h&gt; // PEB yapısı bu kitaplıkta tanımlı.
#include &lt;iostream&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="c1">// Redefine your own CreateFile func. Because we will point to the HMODULE structure returning from the PEB Traversal technique.  </span>

<span class="k">typedef</span> <span class="nf">HANDLE</span><span class="p">(</span><span class="n">WINAPI</span> <span class="o">*</span><span class="n">MY_CREATE_FILE</span><span class="p">)(</span>
	<span class="n">LPCSTR</span>                <span class="n">lpFileName</span><span class="p">,</span>
	<span class="n">DWORD</span>                 <span class="n">dwDesiredAccess</span><span class="p">,</span>
	<span class="n">DWORD</span>                 <span class="n">dwShareMode</span><span class="p">,</span>
	<span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpSecurityAttributes</span><span class="p">,</span>
	<span class="n">DWORD</span>                 <span class="n">dwCreationDisposition</span><span class="p">,</span>
	<span class="n">DWORD</span>                 <span class="n">dwFlagsAndAttributes</span><span class="p">,</span>
	<span class="n">HANDLE</span>                <span class="n">hTemplateFile</span>
<span class="p">);</span>

<span class="c1">// Redefine PEB structures. The structure definitions in winternl.h are incomplete.</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_MY_PEB_LDR_DATA</span> <span class="p">{</span>
	<span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">Initialized</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">SsHandle</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InLoadOrderModuleList</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderModuleList</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InInitializationOrderModuleList</span><span class="p">;</span>
<span class="p">}</span> <span class="n">MY_PEB_LDR_DATA</span><span class="p">,</span> <span class="o">*</span> <span class="n">PMY_PEB_LDR_DATA</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_MY_LDR_DATA_TABLE_ENTRY</span>
<span class="p">{</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InLoadOrderLinks</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InMemoryOrderLinks</span><span class="p">;</span>
	<span class="n">LIST_ENTRY</span> <span class="n">InInitializationOrderLinks</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">DllBase</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">EntryPoint</span><span class="p">;</span>
	<span class="n">ULONG</span> <span class="n">SizeOfImage</span><span class="p">;</span>
	<span class="n">UNICODE_STRING</span> <span class="n">FullDllName</span><span class="p">;</span>
	<span class="n">UNICODE_STRING</span> <span class="n">BaseDllName</span><span class="p">;</span>
<span class="p">}</span> <span class="n">MY_LDR_DATA_TABLE_ENTRY</span><span class="p">,</span> <span class="o">*</span> <span class="n">PMY_LDR_DATA_TABLE_ENTRY</span><span class="p">;</span>



<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">calc_djb2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func_hash</span><span class="p">)</span> <span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">5381</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">hash_chr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">hash_chr</span> <span class="o">=</span> <span class="o">*</span><span class="n">func_hash</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hash</span> <span class="o">=</span> <span class="p">((</span><span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hash</span><span class="p">)</span> <span class="o">+</span> <span class="n">hash_chr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hash</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">HMODULE</span> <span class="nf">get_api_address</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwModuleFunctionHash</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PPEB</span> <span class="n">peb_addr</span><span class="p">;</span>
	<span class="n">PMY_PEB_LDR_DATA</span> <span class="n">pLdr</span><span class="p">;</span>
	<span class="n">PLIST_ENTRY</span> <span class="n">pNextModule</span><span class="p">;</span>
	<span class="n">PMY_LDR_DATA_TABLE_ENTRY</span> <span class="n">pDataTableEntry</span><span class="p">;</span>
	<span class="n">PVOID</span> <span class="n">pModuleBase</span><span class="p">;</span>
	<span class="n">PIMAGE_NT_HEADERS</span> <span class="n">pNTHeader</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">dwExportDirRVA</span><span class="p">;</span>
	<span class="n">PIMAGE_EXPORT_DIRECTORY</span> <span class="n">pExportDir</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">dwNumFunctions</span><span class="p">;</span>
	<span class="n">USHORT</span> <span class="n">usOrdinalTableIndex</span><span class="p">;</span>
	<span class="n">PDWORD</span> <span class="n">pdwFunctionNameBase</span><span class="p">;</span>
	<span class="n">PCSTR</span> <span class="n">pFunctionName</span><span class="p">;</span>
	<span class="n">UNICODE_STRING</span> <span class="n">BaseDllName</span><span class="p">;</span>
	<span class="n">DWORD</span> <span class="n">dwFunctionHash</span><span class="p">;</span>
	<span class="n">PCSTR</span> <span class="n">pTempChar</span><span class="p">;</span>

	<span class="n">DWORD</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef _WIN64
</span>	<span class="n">peb_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPEB</span><span class="p">)</span><span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x60</span><span class="p">);</span>

<span class="cp">#else 
</span>	<span class="n">peb_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPEB</span><span class="p">)</span> <span class="n">__readfsdword</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>

<span class="cp">#endif
</span>	<span class="n">pLdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMY_PEB_LDR_DATA</span><span class="p">)</span><span class="n">peb_addr</span><span class="o">-&gt;</span><span class="n">Ldr</span><span class="p">;</span>
	<span class="n">pNextModule</span> <span class="o">=</span> <span class="n">pLdr</span><span class="o">-&gt;</span><span class="n">InLoadOrderModuleList</span><span class="p">.</span><span class="n">Flink</span><span class="p">;</span>
	<span class="n">pDataTableEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMY_LDR_DATA_TABLE_ENTRY</span><span class="p">)</span><span class="n">pNextModule</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pDataTableEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">pModuleBase</span> <span class="o">=</span> <span class="n">pDataTableEntry</span><span class="o">-&gt;</span><span class="n">DllBase</span><span class="p">;</span>
		<span class="n">BaseDllName</span> <span class="o">=</span> <span class="n">pDataTableEntry</span><span class="o">-&gt;</span><span class="n">BaseDllName</span><span class="p">;</span>
		<span class="n">pNTHeader</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_NT_HEADERS</span><span class="p">)((</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="p">((</span><span class="n">PIMAGE_DOS_HEADER</span><span class="p">)</span><span class="n">pModuleBase</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">);</span>
		<span class="n">dwExportDirRVA</span> <span class="o">=</span> <span class="n">pNTHeader</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">DataDirectory</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="p">;</span>

		<span class="n">pDataTableEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMY_LDR_DATA_TABLE_ENTRY</span><span class="p">)</span><span class="n">pDataTableEntry</span><span class="o">-&gt;</span><span class="n">InLoadOrderLinks</span><span class="p">.</span><span class="n">Flink</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dwExportDirRVA</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pExportDir</span> <span class="o">=</span> <span class="p">(</span><span class="n">PIMAGE_EXPORT_DIRECTORY</span><span class="p">)((</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">dwExportDirRVA</span><span class="p">);</span>

		<span class="n">dwNumFunctions</span> <span class="o">=</span> <span class="n">pExportDir</span><span class="o">-&gt;</span><span class="n">NumberOfNames</span><span class="p">;</span>
		<span class="n">pdwFunctionNameBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">PDWORD</span><span class="p">)((</span><span class="n">PCHAR</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pExportDir</span><span class="o">-&gt;</span><span class="n">AddressOfNames</span><span class="p">);</span>
		
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwNumFunctions</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dwFunctionHash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pFunctionName</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCSTR</span><span class="p">)(</span><span class="o">*</span><span class="n">pdwFunctionNameBase</span> <span class="o">+</span> <span class="p">(</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pModuleBase</span><span class="p">);</span>
			<span class="n">pdwFunctionNameBase</span><span class="o">++</span><span class="p">;</span>

			<span class="n">dwFunctionHash</span> <span class="o">=</span> <span class="n">calc_djb2</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">pFunctionName</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dwFunctionHash</span> <span class="o">==</span> <span class="n">dwModuleFunctionHash</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">usOrdinalTableIndex</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">PUSHORT</span><span class="p">)(((</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pExportDir</span><span class="o">-&gt;</span><span class="n">AddressOfNameOrdinals</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">HMODULE</span><span class="p">)((</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">PDWORD</span><span class="p">)(((</span><span class="n">ULONG_PTR</span><span class="p">)</span><span class="n">pModuleBase</span> <span class="o">+</span> <span class="n">pExportDir</span><span class="o">-&gt;</span><span class="n">AddressOfFunctions</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">usOrdinalTableIndex</span><span class="p">)));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">MY_CREATE_FILE</span> <span class="n">NewCreateFile</span><span class="p">;</span>
	<span class="c1">//3952526842 -&gt; CreateFileA</span>
	<span class="n">NewCreateFile</span>  <span class="o">=</span> <span class="p">(</span><span class="n">MY_CREATE_FILE</span><span class="p">)</span><span class="n">get_api_address</span><span class="p">(</span><span class="mi">3952526842</span><span class="p">);</span>
	<span class="n">NewCreateFile</span><span class="p">(</span><span class="s">"test.txt"</span><span class="p">,</span> <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div> <p>Referans aldığım kod örneğini, bu tekniği yeni okuyacak olanlar için basitleştirdim. Örneğimizde kernel32.dll modülündeki CreateFileA API’sini, direk kullanım yapmadan PEB Traversal tekniği ile basitçe çağırdık. Vee sonuç:</p> <p><img src="/assets/img/peb_traversal_teknigi/img/sonuc.png" alt="CreateFile Sonuç" /></p> <p>Anlamadığınız bir nokta olursa yorumları debug ediyor olacağım. Sağlıklı günler dilerim…</p> <h2 id="kaynakça"> <a href="#kaynakça" class="anchor-head"></a> Kaynakça </h2> <ul> <li>https://theartincode.stanis.me/008-djb2/</li> <li>https://malware.news/t/lets-learn-deep-dive-into-magniber-ransomware-peb-traversal-function</li> <li>https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb</li> <li>https://raw.githubusercontent.com/mattifestation/PIC_Bindshell/master/PIC_Bindshell/GetProcAddressWithHash.h</li> </ul> </div> </article> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'fatihsensoy'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/dlinjector-hizli-dll-enjeksiyonu/" > <div class="nav-arrow">Previous</div> <span class="post-title">DLInjector – Hızlı DLL Enjeksiyon Aracı</span> </a> <a class="post-nav-item post-nav-next" href="/DGA_Domain_Turtle/"> <div class="nav-arrow">Next</div> <span class="post-title">DGA - Domain Turtle For Malwares</span> </a> </nav> <footer class="footer"> <a class="footer_item" href="mailto:iletisim@fatihsensoy.com">Contact Me 📧</a> <a class="footer_item" href="/feed.xml">RSS</a> <small class="footer_copyright"> <span class="footer_item">Fatih Şensoy &copy;2021</span> </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155173124-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-155173124-1'); </script> </div> </div> </body> </html>
